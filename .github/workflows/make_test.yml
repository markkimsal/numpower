name: make_test

on: [push]

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 1
            matrix:
                php: ['8.1', '8.2']
                dependencies: ["liblapacke liblapacke-dev libopenblas0 libopenblas-dev libopenblas0 libopenblas-dev libgd-dev libgd3"]
                os: [ubuntu-latest]

        name: "PHP: ${{ matrix.php }}"

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Setup PHP
              uses: shivammathur/setup-php@verbose
              with:
                  php-version: ${{ matrix.php }}
                  coverage: none
                  extensions: gd, numpower-Numpower/numpower@main
                  tools: phpize
              env:
                NUMPOWER_LINUX_LIBS: ${{ matrix.dependencies }}

            - name: Execute tests USE_ZEND_ALLOC 1
              run: make test
              env:
                  NDARRAY_FREEBUFFER: 1
                  USE_ZEND_ALLOC: 1

            - name: Execute tests USE_ZEND_ALLOC 0
              run: make test
              env:
                  USE_ZEND_ALLOC: 0
